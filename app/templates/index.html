<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TheStickerHouse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/prompt_input_style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='ico/TheStickerHouseLogo.ico') }}" type="image/x-icon">
</head>
<body>
    
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <button id="buy-coins-btn-header" class="buy-coins-btn">
                        <i class="ri-coin-line"></i> <span id="coins-count-header">0</span>
                    </button>
                </div>
                
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='logo/TheStickerHouseLogo.PNG') }}" alt="Logo TheStickerHouse" class="main-logo">
                </div>
                
                <div class="header-right">
                    <button id="history-page-btn" class="history-page-btn">
                        <i class="ri-history-line"></i> <span>Historial</span>
                    </button>
                    <button id="login-btn" class="login-btn">
                        <i class="ri-user-line"></i> <span>Iniciar Sesión</span>
                    </button>
                </div>
            </div>
        </header>
        
        <main class="card-container">
            <!-- Main Card: Sticker Generator -->
            <div class="card main-card">
                <div class="input-section">
                    <div id="unified-input-mode" class="generation-mode">
                        <div class="quality-selector">
                            <label>Calidad:</label>
                            <div class="quality-options">
                                <input type="radio" id="quality-low" name="quality" value="low" checked>
                                <label for="quality-low">
                                    <div class="main-label-content">Baja</div>
                                    <span class="quality-cost">10 monedas</span>
                                </label>
                                <input type="radio" id="quality-medium" name="quality" value="medium">
                                <label for="quality-medium">
                                    <div class="main-label-content">Media</div>
                                    <span class="quality-cost">25 monedas</span>
                                </label>
                                <input type="radio" id="quality-high" name="quality" value="high">
                                <label for="quality-high">
                                    <div class="main-label-content">Alta <span class="high-quality-sparkle">✨</span></div>
                                    <span class="quality-cost">100 monedas</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="prompt-input-container">
                            <div id="reference-image-preview" class="reference-image-thumbnail hidden">
                                <img src="" alt="Imagen de referencia">
                                <button type="button" class="remove-thumbnail-btn" title="Eliminar imagen">
                                    <i class="ri-close-line"></i>
                                </button>
                            </div>
                            <textarea id="prompt-input" placeholder="Describí tu sticker... (ej., 'un panda tierno comiendo bambú en un fondo transparente')"></textarea>
                            
                            <div class="reference-image-controls">
                                <button id="styles-btn" class="styles-btn" title="Elegir estilo de sticker">
                                    <i class="ri-brush-line"></i>
                                    <span id="selected-style-name" class="style-name">Seleccionar estilo</span>
                                </button>
                                <button id="add-reference-btn" class="add-reference-btn" title="Agregar imagen de referencia">
                                    <i class="ri-camera-line"></i>
                                </button>
                                <input type="file" id="reference-image-input" accept="image/*" class="file-input hidden">
                            </div>
                        </div>
                    </div>
                    
                    <button id="generate-btn"><i class="ri-magic-line"></i> Generar Sticker</button>
                </div>
                
                <div class="results-section" id="results-section">
                    <div class="loading-spinner hidden" id="loading-spinner">
                        <div class="spinner"></div>
                        <p>Generando tu sticker...</p>
                    </div>
                    
                    <div class="sticker-result">
                        <div class="sticker-image-container">
                            <img id="sticker-image" src="" alt="Sticker generado">
                        </div>
                        <div class="sticker-actions">
                            <a id="download-btn" href="#" download class="download-button"><i class="ri-download-cloud-line"></i> Descargar</a>
                            <button id="add-to-template-btn" class="template-button"><i class="ri-add-circle-fill"></i> Agregar a Plantilla</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Template Card: Separate card below the main card -->
            <div class="card template-card" id="template-section">
                <div class="template-header">
                    <h2><i class="ri-grid-fill"></i> Plantilla de Stickers</h2>
                    <div class="template-actions">
                        <button id="download-template-btn" class="download-button"><i class="ri-download-cloud-line"></i> Descargar</button>
                        <button id="buy-stickers-btn" class="buy-button"><i class="ri-shopping-cart-line"></i> Comprar Stickers</button>
                        <button id="clear-template-btn" class="clear-button"><i class="ri-delete-bin-6-line"></i> Limpiar Todo</button>
                    </div>
                </div>
                
                <div class="template-grid" id="template-grid">
                    <div class="empty-template-message">
                        <i class="ri-image-add-fill"></i>
                        <p>Tu plantilla está vacía</p>
                        <span>Generá stickers y agregalos para crear una plantilla para imprimir</span>
                    </div>
                    <!-- Stickers will be added here dynamically -->
                </div>
            </div>
        </main>
        
        <footer class="footer-professional">
            <div class="footer-content">
                <span class="powered-by">Powered by <a href="https://wormhole-ai.com" target="_blank" rel="noopener">Wormhole AI</a></span>
                <br>
                <span>&copy; 2025 TheStickerHouse. Todos los derechos reservados.</span>
            </div>
        </footer>
    </div>
    
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    
    <!-- Mercado Pago SDK -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <!-- Pass MP Public Key from Flask to JavaScript -->
    <script>
        const mpPublicKey = "{{ mp_public_key }}";
    </script>
    
    <!-- Success/Error Toast Messages -->
    <div class="success-toast" id="success-toast">
        <i class="ri-checkbox-circle-line"></i>
        <span id="success-message">¡Éxito!</span>
    </div>
    
    <div class="error-toast" id="error-toast">
        <i class="ri-error-warning-line"></i>
        <span id="error-message">¡Error!</span>
    </div>
    
    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="modal-close-btn"><i class="ri-close-line"></i></button>
            <h2>Finalizar Compra</h2>
            <p>Por favor, proporcioná tus datos para completar la compra.</p>
            
            <form id="checkout-form">
                <div class="form-group">
                    <label for="checkout-name">Nombre:</label>
                    <input type="text" id="checkout-name" name="name" required placeholder="Ingresá tu nombre completo">
                </div>
                <div class="form-group">
                    <label for="checkout-email">Email:</label>
                    <input type="email" id="checkout-email" name="email" required placeholder="Ingresá tu dirección de email">
                </div>
                <div class="form-group">
                    <label for="checkout-address">Dirección:</label>
                    <textarea id="checkout-address" name="address" rows="3" required placeholder="Ingresá tu dirección de envío"></textarea>
                </div>
                
                <button type="submit" id="finalize-payment-btn" class="finalize-button"><i class="ri-secure-payment-line"></i> Finalizar Pago</button>
            </form>
        </div>
    </div>
    
    <!-- Coins Purchase Modal -->
    <div id="coins-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-btn" id="coins-modal-close-btn"><i class="ri-close-line"></i></button>
            <h2>Comprar Monedas</h2>
            <p>¡Comprá monedas para crear más stickers!</p>
            
            <div class="coins-packages">
                <div class="coins-loading">
                    <i class="ri-loader-4-line rotate"></i>
                    <p>Cargando paquetes de monedas...</p>
                </div>
            </div>
            
            <div class="coupon-section">
                <p>¿Tenés un código de cupón?</p>
                <div class="form-group compact-form">
                    <div class="coupon-container">
                        <input type="text" id="coins-coupon-direct" name="coupon" placeholder="Ingresá el código de descuento">
                        <button type="button" id="apply-coupon-direct-btn" class="apply-coupon-button">Aplicar</button>
                    </div>
                    <p id="coupon-direct-status" class="coupon-status"></p>
                </div>
            </div>
            
            <form id="coins-form" class="hidden">
                <div class="selected-package-info">
                    <p>Seleccionado: <span id="selected-package-name">Paquete Mediano</span></p>
                    <p>Cantidad: <span id="selected-package-amount">300</span> monedas</p>
                    <p>Precio: $<span id="selected-package-price">1000.00</span></p>
                </div>
                
                <div class="form-group">
                    <label for="coins-name">Nombre:</label>
                    <input type="text" id="coins-name" name="name" required placeholder="Ingresá tu nombre completo">
                </div>
                <div class="form-group">
                    <label for="coins-email">Email:</label>
                    <input type="email" id="coins-email" name="email" required placeholder="Ingresá tu dirección de email">
                </div>
                
                <button type="submit" id="finalize-coins-btn" class="finalize-button">
                    <i class="ri-secure-payment-line"></i> Comprar Monedas
                </button>
                <button type="button" id="back-to-packages-btn" class="back-button">
                    <i class="ri-arrow-left-line"></i> Volver a Paquetes
                </button>
            </form>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modern-image-modal">
            <div class="image-container">
                <img id="enlarged-image" src="" alt="Imagen de referencia ampliada">
            </div>
            <button type="button" id="image-modal-close-btn" class="modern-close-btn" aria-label="Cerrar modal">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Styles Selection Modal -->
    <div id="styles-selection-modal" class="modal hidden">
        <div class="modal-content styles-modal-content">
            <button class="modal-close-btn" id="styles-modal-close-btn"><i class="ri-close-line"></i></button>
            <h2>Seleccionar Estilo de Sticker</h2>
            <p>Elegí un estilo para mejorar la apariencia de tu sticker</p>
            
            <div class="styles-grid" id="styles-grid">
                <!-- Los estilos se cargarán dinámicamente aquí -->
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-overlay" id="login-modal-overlay"></div>
        <div class="modal-content">
            <button class="modal-close-btn" id="login-modal-close-btn"><i class="ri-close-line"></i></button>
            <h2>Iniciar Sesión</h2>
            <p>Ingresá tu email para recibir un código PIN seguro.</p>
            
            <div id="email-form-container">
                <form id="email-form">
                    <div class="form-group">
                        <label for="login-email">Email:</label>
                        <input type="email" id="login-email" name="email" required placeholder="Ingresá tu dirección de email" style="width: 100%; padding: 14px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 0.95rem; transition: var(--transition);">
                    </div>
                    <button type="submit" id="send-pin-btn" class="login-button"><i class="ri-mail-send-line"></i> Enviar PIN</button>
                </form>
            </div>
            
            <div id="name-form-container" class="hidden">
                <p class="new-user-message">¡Bienvenido! Por favor, proporcioná tu nombre para crear una cuenta.</p>
                <form id="name-form">
                    <div class="form-group">
                        <label for="login-name">Nombre:</label>
                        <input type="text" id="login-name" name="name" required placeholder="Ingresá tu nombre" style="width: 100%; padding: 14px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 0.95rem; transition: var(--transition);">
                    </div>
                    <button type="submit" id="create-account-btn" class="login-button"><i class="ri-user-add-line"></i> Crear Cuenta</button>
                </form>
            </div>
            
            <div id="pin-form-container" class="hidden">
                <p class="pin-sent-message">¡PIN enviado! Revisá tu email e ingresá el código a continuación.</p>
                <form id="pin-form">
                    <div class="form-group">
                        <label for="login-pin">Código PIN:</label>
                        <input type="text" id="login-pin" name="pin" required placeholder="Ingresá el PIN de 6 dígitos" maxlength="6" style="width: 100%; padding: 14px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 0.95rem; transition: var(--transition);">
                    </div>
                    <button type="submit" id="verify-pin-btn" class="login-button"><i class="ri-shield-check-line"></i> Verificar PIN</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Login functionality
        document.addEventListener('DOMContentLoaded', function() {
            const loginBtn = document.getElementById('login-btn');
            const loginModal = document.getElementById('login-modal');
            const loginModalCloseBtn = document.getElementById('login-modal-close-btn');
            const loginModalOverlay = document.getElementById('login-modal-overlay');
            const emailForm = document.getElementById('email-form');
            const nameForm = document.getElementById('name-form');
            const pinForm = document.getElementById('pin-form');
            const emailFormContainer = document.getElementById('email-form-container');
            const nameFormContainer = document.getElementById('name-form-container');
            const pinFormContainer = document.getElementById('pin-form-container');
            
            // History button redirection
            const historyBtn = document.getElementById('history-page-btn');
            historyBtn.addEventListener('click', function() {
                window.location.href = '/history';
            });
            
            // Function to open login modal - make it globally accessible
            window.openLoginModal = function() {
                console.log('Login modal opened');
                loginModal.classList.remove('hidden');
                loginModal.style.display = 'flex';
                loginModal.style.opacity = '1';
                loginModal.style.visibility = 'visible';
            }
            
            // Function to close login modal - make it globally accessible
            window.closeLoginModal = function() {
                loginModal.classList.add('hidden');
                loginModal.style.opacity = '0';
                loginModal.style.visibility = 'hidden';
                setTimeout(() => {
                    loginModal.style.display = 'none';
                }, 300);
                
                // Reset forms
                emailForm.reset();
                nameForm.reset();
                pinForm.reset();
                emailFormContainer.classList.remove('hidden');
                nameFormContainer.classList.add('hidden');
                pinFormContainer.classList.add('hidden');
            }
            
            // Open login modal when login button is clicked
            loginBtn.addEventListener('click', function() {
                // Check if user is already logged in by looking at the button text
                if (loginBtn.querySelector('span') && loginBtn.innerHTML.includes('ri-user-fill')) {
                    // User is logged in, show logout menu
                    showLogoutMenu();
                } else {
                    // User is not logged in, show login modal
                    openLoginModal();
                }
            });
            
            // Logout menu functionality
            function showLogoutMenu() {
                // Create logout menu if it doesn't exist
                let logoutMenu = document.getElementById('logout-menu');
                if (!logoutMenu) {
                    logoutMenu = document.createElement('div');
                    logoutMenu.id = 'logout-menu';
                    logoutMenu.className = 'logout-menu';
                    logoutMenu.innerHTML = `
                        <div class="logout-menu-item" id="logout-btn">
                            <i class="ri-logout-box-line"></i> Cerrar Sesión
                        </div>
                        <div class="logout-menu-item" id="view-profile-btn">
                            <i class="ri-user-settings-line"></i> Ver Perfil
                        </div>
                        <style>
                            .logout-menu {
                                position: absolute;
                                top: 100%;
                                right: 0;
                                background: white;
                                border-radius: 10px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                overflow: hidden;
                                width: 180px;
                                z-index: 1000;
                                opacity: 0;
                                transform: translateY(-10px);
                                pointer-events: none;
                                transition: opacity 0.2s ease, transform 0.2s ease;
                            }
                            .logout-menu.active {
                                opacity: 1;
                                transform: translateY(0);
                                pointer-events: all;
                            }
                            .logout-menu-item {
                                padding: 12px 16px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: background 0.2s ease;
                            }
                            .logout-menu-item:hover {
                                background: #f5f5f5;
                            }
                            .logout-menu-item i {
                                font-size: 18px;
                            }
                        </style>
                    `;
                    
                    // Position the menu relative to the login button
                    const headerRight = document.querySelector('.header-right');
                    headerRight.style.position = 'relative';
                    headerRight.appendChild(logoutMenu);
                    
                    // Add event listeners for logout menu items
                    document.getElementById('logout-btn').addEventListener('click', handleLogout);
                    document.getElementById('view-profile-btn').addEventListener('click', viewProfile);
            
                    // Close menu when clicking outside
                    document.addEventListener('click', function(e) {
                        if (logoutMenu.classList.contains('active') && 
                            !logoutMenu.contains(e.target) && 
                            !loginBtn.contains(e.target)) {
                            logoutMenu.classList.remove('active');
                        }
                    });
                }
                
                // Toggle menu visibility
                logoutMenu.classList.toggle('active');
            }
            
            // Handle logout
            function handleLogout() {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI for logged out state
                        loginBtn.innerHTML = '<i class="ri-user-line"></i> <span>Iniciar Sesión</span>';
                        
                        // Hide logout menu
                        const logoutMenu = document.getElementById('logout-menu');
                        if (logoutMenu) {
                            logoutMenu.classList.remove('active');
                        }
                        
                        // Reset coins if applicable
                        if (typeof updateCoinsDisplay === 'function') {
                            currentCoins = 0;
                            updateCoinsDisplay();
                        } else {
                            // Direct update if updateCoinsDisplay is not available
                            const coinsElement = document.getElementById('coins-count-header');
                            if (coinsElement) {
                                coinsElement.textContent = '0';
                            }
                        }
                        
                        // Show success message
                        const successMessage = document.createElement('div');
                        successMessage.className = 'info-toast';
                        successMessage.innerHTML = '<i class="ri-checkbox-circle-line"></i> Sesión cerrada correctamente';
                        document.body.appendChild(successMessage);
                        
                        // Show toast
                        setTimeout(() => {
                            successMessage.classList.add('show');
                        }, 100);
                        
                        // Hide toast
                        setTimeout(() => {
                            successMessage.classList.remove('show');
                            setTimeout(() => {
                                successMessage.remove();
                            }, 300);
                        }, 2000);
                    } else {
                        // Show error
                        alert(data.error || 'Error al cerrar sesión. Por favor, intentá nuevamente.');
                    }
                })
                .catch(error => {
                    console.error('Error logging out:', error);
                    alert('Error de red. Por favor, intentá nuevamente.');
                });
            }
            
            // View profile function
            function viewProfile() {
                // Close the logout menu
                const logoutMenu = document.getElementById('logout-menu');
                if (logoutMenu) {
                    logoutMenu.classList.remove('active');
                }
                
                // For now, just show a toast message
                const infoMessage = document.createElement('div');
                infoMessage.className = 'info-toast';
                infoMessage.innerHTML = '<i class="ri-information-line"></i> ¡Vista de perfil próximamente!';
                document.body.appendChild(infoMessage);
                
                // Show toast
                setTimeout(() => {
                    infoMessage.classList.add('show');
                }, 100);
                
                // Hide toast
                setTimeout(() => {
                    infoMessage.classList.remove('show');
                    setTimeout(() => {
                        infoMessage.remove();
                    }, 300);
                }, 2000);
            }
            
            // Handle email form submission (request PIN)
            emailForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                
                // Frontend validation
                if (!email) {
                    alert('Por favor, ingresá tu dirección de email');
                    return;
                }
                
                // Show loading state
                const sendPinBtn = document.getElementById('send-pin-btn');
                const originalBtnText = sendPinBtn.innerHTML;
                sendPinBtn.disabled = true;
                sendPinBtn.innerHTML = '<i class="ri-loader-4-line"></i> Enviando...';
                
                // Call API to request PIN
                fetch('/api/auth/request-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    sendPinBtn.disabled = false;
                    sendPinBtn.innerHTML = originalBtnText;
                    
                    if (data.success) {
                        // Store email for PIN verification
                        sessionStorage.setItem('auth_email', email);
                        
                        // Check if user exists or needs registration
                        if (data.user_exists) {
                            // Existing user - show PIN entry form
                            emailFormContainer.classList.add('hidden');
                            pinFormContainer.classList.remove('hidden');
                        } else {
                            // New user - show name form
                            emailFormContainer.classList.add('hidden');
                            nameFormContainer.classList.remove('hidden');
                        }
                    } else {
                        // Show error
                        alert(data.error || 'No se pudo enviar el PIN. Por favor, intentá nuevamente.');
                    }
                })
                .catch(error => {
                    // Reset button state
                    sendPinBtn.disabled = false;
                    sendPinBtn.innerHTML = originalBtnText;
                    
                    // Show error
                    console.error('Error sending PIN:', error);
                    alert('Error de red. Por favor, intentá nuevamente.');
                });
            });
            
            // Handle name form submission (create account)
            nameForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('login-name').value;
                const email = sessionStorage.getItem('auth_email');
                
                // Frontend validation
                if (!name) {
                    alert('Por favor, ingresá tu nombre');
                    return;
                }
                
                if (!email) {
                    alert('Sesión expirada. Por favor, intentá nuevamente.');
                    // Go back to email form
                    nameFormContainer.classList.add('hidden');
                    emailFormContainer.classList.remove('hidden');
                    return;
                }
                
                // Show loading state
                const createAccountBtn = document.getElementById('create-account-btn');
                const originalBtnText = createAccountBtn.innerHTML;
                createAccountBtn.disabled = true;
                createAccountBtn.innerHTML = '<i class="ri-loader-4-line"></i> Creando...';
                
                // Call API to create account
                fetch('/api/auth/create-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, name })
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    createAccountBtn.disabled = false;
                    createAccountBtn.innerHTML = originalBtnText;
                    
                    if (data.success) {
                        // Account created, show PIN entry form
                        nameFormContainer.classList.add('hidden');
                        pinFormContainer.classList.remove('hidden');
                        
                        // Update pin sent message
                        const pinMessage = document.querySelector('.pin-sent-message');
                        pinMessage.textContent = '¡Cuenta creada! Ingresá el PIN enviado a tu email.';
                    } else {
                        // Show error
                        alert(data.error || 'No se pudo crear la cuenta. Por favor, intentá nuevamente.');
                        
                        // If user already exists, go to PIN form
                        if (data.user_exists) {
                            nameFormContainer.classList.add('hidden');
                            pinFormContainer.classList.remove('hidden');
                        }
                    }
                })
                .catch(error => {
                    // Reset button state
                    createAccountBtn.disabled = false;
                    createAccountBtn.innerHTML = originalBtnText;
                    
                    // Show error
                    console.error('Error creating account:', error);
                    alert('Error de red. Por favor, intentá nuevamente.');
                });
            });
            
            // Handle PIN form submission (verify PIN)
            pinForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const pin = document.getElementById('login-pin').value;
                const email = sessionStorage.getItem('auth_email');
                
                // Frontend validation
                if (!pin || pin.length !== 6 || !/^\d+$/.test(pin)) {
                    alert('Por favor, ingresá un PIN válido de 6 dígitos');
                    return;
                }
                
                if (!email) {
                    alert('Sesión expirada. Por favor, intentá nuevamente.');
                    // Go back to email form
                    pinFormContainer.classList.add('hidden');
                    emailFormContainer.classList.remove('hidden');
                    return;
                }
                
                // Show loading state
                const verifyPinBtn = document.getElementById('verify-pin-btn');
                const originalBtnText = verifyPinBtn.innerHTML;
                verifyPinBtn.disabled = true;
                verifyPinBtn.innerHTML = '<i class="ri-loader-4-line"></i> Verificando...';
                
                // Call API to verify PIN
                fetch('/api/auth/verify-pin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, pin })
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    verifyPinBtn.disabled = false;
                    verifyPinBtn.innerHTML = originalBtnText;
                    
                    if (data.success) {
                        // Update UI based on successful login
                        // Use name if available, otherwise use email
                        const displayName = data.user.name || data.user.email;
                        loginBtn.innerHTML = '<i class="ri-user-fill"></i> <span>' + displayName + '</span>';
                        
                        // Update coins display if needed
                        if (typeof updateCoinsDisplay === 'function' && data.user.coins !== undefined) {
                            currentCoins = data.user.coins;
                            updateCoinsDisplay();
                        } else {
                            // Direct update if updateCoinsDisplay is not available
                            const coinsElement = document.getElementById('coins-count-header');
                            if (coinsElement && data.user.coins !== undefined) {
                                coinsElement.textContent = data.user.coins;
                            }
                        }
                        
                        // Show success message
                        const successMessage = document.createElement('div');
                        successMessage.className = 'info-toast';
                        successMessage.innerHTML = '<i class="ri-checkbox-circle-line"></i> ¡Inicio de sesión exitoso!';
                        document.body.appendChild(successMessage);
                        
                        // Show toast
                        setTimeout(() => {
                            successMessage.classList.add('show');
                        }, 100);
                        
                        // Hide toast and close modal
                        setTimeout(() => {
                            successMessage.classList.remove('show');
                            closeLoginModal();
                            
                            // Check for pending coin purchase 
                            const pendingCoinPackage = sessionStorage.getItem('pendingCoinPackage');
                            if (pendingCoinPackage && typeof selectPackage === 'function') {
                                setTimeout(() => {
                                    // Select the package that was chosen before login
                                    selectPackage(pendingCoinPackage);
                                    // Remove from session storage
                                    sessionStorage.removeItem('pendingCoinPackage');
                                }, 500);
                            }
                            
                            // Check for pending checkout
                            const pendingCheckout = sessionStorage.getItem('pendingCheckout');
                            if (pendingCheckout === 'true' && typeof continueCheckout === 'function') {
                                setTimeout(() => {
                                    // Continue with checkout process
                                    continueCheckout();
                                    // Remove from session storage
                                    sessionStorage.removeItem('pendingCheckout');
                                }, 500);
                            }
                            
                            setTimeout(() => {
                                successMessage.remove();
                            }, 300);
                        }, 2000);
                        
                        // Clear stored email
                        sessionStorage.removeItem('auth_email');
                    } else {
                        // Show error
                        alert(data.error || 'PIN inválido. Por favor, intentá nuevamente.');
                        // Clear PIN input
                        document.getElementById('login-pin').value = '';
                    }
                })
                .catch(error => {
                    // Reset button state
                    verifyPinBtn.disabled = false;
                    verifyPinBtn.innerHTML = originalBtnText;
                    
                    // Show error
                    console.error('Error verifying PIN:', error);
                    alert('Error de red. Por favor, intentá nuevamente.');
                });
            });
            
            // Check if user is already logged in
            fetch('/api/auth/me')
                .then(response => response.json())
                .then(data => {
                    if (data.user) {
                        // Update UI for logged in user
                        // Use name if available, otherwise use email
                        const displayName = data.user.name || data.user.email;
                        loginBtn.innerHTML = '<i class="ri-user-fill"></i> <span>' + displayName + '</span>';
                        
                        // Update coins if applicable
                        if (typeof updateCoinsDisplay === 'function' && data.user.coins !== undefined) {
                            currentCoins = data.user.coins;
                            updateCoinsDisplay();
                        } else {
                            // Direct update if updateCoinsDisplay is not available
                            const coinsElement = document.getElementById('coins-count-header');
                            if (coinsElement && data.user.coins !== undefined) {
                                coinsElement.textContent = data.user.coins;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                });
            
            // Close login modal when close button is clicked
            loginModalCloseBtn.addEventListener('click', closeLoginModal);
            
            // Close login modal when clicking outside of it (on the overlay)
            loginModalOverlay.addEventListener('click', closeLoginModal);
            
            // Prevent clicks on the modal content from closing the modal
            loginModal.querySelector('.modal-content').addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    </script>

    <style>
        /* Additional styles for name form */
        .new-user-message {
            color: var(--accent-color);
            font-weight: 500;
            margin-bottom: 20px;
            padding: 12px;
            background-color: rgba(255, 107, 155, 0.1);
            border-radius: 8px;
            text-align: center;
        }
        
        #login-name:focus {
            outline: none;
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(255, 107, 155, 0.1) !important;
        }
        
        #name-form-container {
            width: 100%;
            padding-top: 10px;
        }
        
        #create-account-btn {
            background: linear-gradient(45deg, var(--accent-color), #ff8ab4);
            box-shadow: 0 8px 20px rgba(255, 107, 155, 0.25);
        }
        
        #create-account-btn:hover {
            box-shadow: 0 12px 25px rgba(255, 107, 155, 0.35);
        }
    </style>
</body>
</html> 