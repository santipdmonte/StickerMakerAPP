<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/css/admin_style.css">
</head>
<body>
    <div class="admin-dashboard-container">
        <h1 style="background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; color: transparent; font-size: 2.5rem; margin-bottom: 32px; letter-spacing: -1px;">Admin Dashboard</h1>
        <div class="admin-kpi-row">
            <div class="admin-kpi-card">
                <div class="admin-kpi-title">Total Users</div>
                <div class="admin-kpi-value">{{ total_users }}</div>
            </div>
            <div class="admin-kpi-card">
                <div class="admin-kpi-title">New Users (7d)</div>
                <div class="admin-kpi-value">{{ new_users }}</div>
            </div>
            <div class="admin-kpi-card">
                <div class="admin-kpi-title">Active Users (24h)</div>
                <div class="admin-kpi-value">{{ active_users }}</div>
            </div>
            <div class="admin-kpi-card">
                <div class="admin-kpi-title">Paid Users (30d)</div>
                <div class="admin-kpi-value">{{ paid_users }}</div>
            </div>
            <div class="admin-kpi-card">
                <div class="admin-kpi-title">Total Transactions</div>
                <div class="admin-kpi-value">{{ total_transactions }}</div>
            </div>
            <div class="admin-kpi-card">
                <div class="admin-kpi-title">Total Revenue</div>
                <div class="admin-kpi-value">{{ total_revenue }}</div>
            </div>
            <div class="admin-kpi-card">
                <div class="admin-kpi-title">Avg. Order Value</div>
                <div class="admin-kpi-value">{{ avg_order_value|round(2) }}</div>
            </div>
        </div>

        <div class="admin-requests-section">
            <h2>Recent Admin Requests</h2>
            {% if recent_admin_requests and recent_admin_requests|length > 0 %}
            <table class="admin-requests-table">
                <tr>
                    <th>Email</th>
                    <th>Requested At</th>
                    <th>Status</th>
                </tr>
                {% for req in recent_admin_requests %}
                <tr>
                    <td>{{ req.email }}</td>
                    <td>{{ req.created_at_str }}</td>
                    <td class="status-{{ req.status }}">{{ req.status }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
                <p>No pending admin requests.</p>
            {% endif %}
        </div>
    </div>

    <!-- Botón para abrir el modal de crear cupón -->
    <button id="open-create-coupon-modal" class="admin-action-btn" style="margin: 32px 0 0 0; padding: 12px 28px; font-size: 1.1rem; background: linear-gradient(45deg, #ff6b9b, #ff9eb5); color: #fff; border: none; border-radius: 30px; cursor: pointer; font-weight: 600;">Crear cupón</button>

    <!-- Modal para crear cupón -->
    <div id="create-coupon-modal" class="modal hidden" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div class="modal-content" style="background: #fff; border-radius: 18px; padding: 32px 28px; min-width: 340px; max-width: 95vw; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative;">
            <button id="close-create-coupon-modal" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h2 style="margin-bottom: 18px;">Crear nuevo cupón</h2>
            <form id="create-coupon-form">
                <div style="margin-bottom: 12px;">
                    <label for="coupon_code">Código del cupón:</label>
                    <input type="text" id="coupon_code" name="coupon_code" required style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="coupons_left">Usos disponibles:</label>
                    <input type="number" id="coupons_left" name="coupons_left" min="1" value="1" required style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="coupon_type">Tipo de cupón:</label>
                    <select id="coupon_type" name="coupon_type" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                        <option value="coins">Monedas</option>
                        <option value="discount">Descuento (%)</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;" id="coins_value_group">
                    <label for="coins_value">Monedas a otorgar:</label>
                    <input type="number" id="coins_value" name="coins_value" min="0" value="0" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 12px; display: none;" id="discount_percent_group">
                    <label for="discount_percent">Descuento (%):</label>
                    <input type="number" id="discount_percent" name="discount_percent" min="0" max="100" value="0" step="0.01" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="expires_at">Expira (timestamp, opcional):</label>
                    <input type="number" id="expires_at" name="expires_at" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 18px;">
                    <label for="is_active">Activo:</label>
                    <input type="checkbox" id="is_active" name="is_active" checked>
                </div>
                <button type="submit" style="background: linear-gradient(45deg, #ff6b9b, #ff9eb5); color: #fff; border: none; border-radius: 30px; padding: 10px 22px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%;">Crear cupón</button>
                <p id="create-coupon-status" style="margin-top: 10px; font-size: 0.98rem;"></p>
            </form>
        </div>
    </div>

    <script>
    // Modal logic
    const openBtn = document.getElementById('open-create-coupon-modal');
    const modal = document.getElementById('create-coupon-modal');
    const closeBtn = document.getElementById('close-create-coupon-modal');
    openBtn.onclick = () => { modal.classList.remove('hidden'); };
    closeBtn.onclick = () => { modal.classList.add('hidden'); };
    window.onclick = (e) => { if (e.target === modal) modal.classList.add('hidden'); };

    // Mostrar/ocultar campos según tipo de cupón
    const couponType = document.getElementById('coupon_type');
    const coinsGroup = document.getElementById('coins_value_group');
    const discountGroup = document.getElementById('discount_percent_group');
    couponType.onchange = function() {
        if (this.value === 'coins') {
            coinsGroup.style.display = '';
            discountGroup.style.display = 'none';
        } else {
            coinsGroup.style.display = 'none';
            discountGroup.style.display = '';
        }
    };

    // Enviar formulario vía fetch
    document.getElementById('create-coupon-form').onsubmit = async function(e) {
        e.preventDefault();
        const status = document.getElementById('create-coupon-status');
        status.textContent = '';
        const data = {
            coupon_code: this.coupon_code.value,
            coupons_left: this.coupons_left.value,
            coupon_initial_number: this.coupons_left.value,
            coupon_type: this.coupon_type.value,
            coins_value: this.coupon_type.value === 'coins' ? this.coins_value.value : 0,
            discount_percent: this.coupon_type.value === 'discount' ? this.discount_percent.value : 0,
            expires_at: this.expires_at.value || 0,
            is_active: this.is_active.checked ? 1 : 0
        };
        try {
            const resp = await fetch('/coupons', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await resp.json();
            if (resp.ok) {
                status.textContent = 'Cupón creado correctamente';
                status.style.color = '#22c55e';
                this.reset();
            } else {
                status.textContent = result.error || 'Error al crear cupón';
                status.style.color = '#ef4444';
            }
        } catch (err) {
            status.textContent = 'Error de red o servidor';
            status.style.color = '#ef4444';
        }
    };
    </script>
</body>
</html> 