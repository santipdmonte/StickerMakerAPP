<!DOCTYPE html>
<html>
<head>
    <title>Administrar Cupones</title>
    <link rel="stylesheet" href="/static/css/admin_style.css">
</head>
<body>
    <div class="admin-dashboard-container">
        <h1 class="admin-title">Administrar Cupones</h1>
        <a href="/admin" class="admin-action-btn">Volver al dashboard</a>

        <div id="coupon-message"></div>
        <form id="coupon-form" action="/coupons" method="post" class="admin-coupon-form">
            <div class="form-group">
                <label for="coupon_code">Código del cupón</label>
                <input type="text" id="coupon_code" name="coupon_code" required>
            </div>
            <div class="form-group">
                <label for="coupons_left">Cantidad disponible</label>
                <input type="number" id="coupons_left" name="coupons_left" min="1" value="1" required>
            </div>
            <div class="form-group">
                <label for="is_active">Activo</label>
                <select id="is_active" name="is_active">
                    <option value="1">Sí</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expires_at">Fecha de expiración (opcional)</label>
                <input type="number" id="expires_at" name="expires_at" min="0">
            </div>
            <div class="form-group">
                <label for="coupon_type">Tipo de cupón</label>
                <select id="coupon_type" name="coupon_type" onchange="toggleCouponInputs()">
                    <option value="coins">Coins</option>
                    <option value="discount">Descuento (%)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="coins_value">Valor en coins</label>
                <input type="number" id="coins_value" name="coins_value" min="0">
            </div>
            <div class="form-group">
                <label for="discount_percent">Descuento (%)</label>
                <input type="number" id="discount_percent" name="discount_percent" min="0" max="100">
            </div>
            <button type="submit" class="admin-action-btn">Crear cupón</button>
        </form>
        <script>
            // --- ADMIN: Formulario de cupones ---
            const couponForm = document.getElementById('coupon-form');
            const couponMessage = document.getElementById('coupon-message');
            if (couponForm && couponMessage) {
                couponForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    couponMessage.innerHTML = '';
                    const formData = new FormData(couponForm);
                    const data = {};
                    formData.forEach((value, key) => {
                        data[key] = value;
                    });
                    try {
                        const response = await fetch('/coupons', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify(data)
                        });
                        const contentType = response.headers.get('Content-Type');
                        let result = {};
                        if (contentType && contentType.includes('application/json')) {
                            result = await response.json();
                        } else {
                            result = { error: 'Respuesta inesperada del servidor.' };
                        }
                        if (response.ok && result.coupon_code) {
                            couponMessage.innerHTML = `<div class='admin-success-message'>¡Cupón creado exitosamente! Código: <strong>${result.coupon_code}</strong></div>`;
                            couponForm.reset();
                            toggleCouponInputs();
                        } else {
                            couponMessage.innerHTML = `<div class='admin-error-message'>${result.error || 'Error al crear el cupón.'}</div>`;
                        }
                    } catch (err) {
                        couponMessage.innerHTML = `<div class='admin-error-message'>${err.message || 'Error de red.'}</div>`;
                    }
                });
            }


            function toggleCouponInputs() {
                var type = document.getElementById('coupon_type').value;
                var coinsInput = document.getElementById('coins_value');
                var discountInput = document.getElementById('discount_percent');
                if (type === 'coins') {
                    coinsInput.disabled = false;
                    discountInput.disabled = true;
                    discountInput.value = '';
                } else {
                    coinsInput.disabled = true;
                    coinsInput.value = '';
                    discountInput.disabled = false;
                }
            }
            // Inicializar al cargar la página
            document.addEventListener('DOMContentLoaded', function() {
                toggleCouponInputs();
            });
        </script>
    </div>
</body>
</html>
